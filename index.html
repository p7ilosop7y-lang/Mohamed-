<!doctype html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>mohamed tammam portfolio</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<style>
    :root{
      /* لوحة الألوان الأصلية: أزرق داكن ووردي ساطع */
      --bg:#0a0f1a;
      --card:#131c2b;
      --muted: #b0bac8;
      --accent:#ff6b9d; /* لون وردي ساطع */
      --text: #f3f5f7;
    }
    body{font-family:'Poppins', sans-serif;background:var(--bg);color:var(--text);margin:0;display:flex;flex-direction:column;min-height:100vh}
    header{padding:16px 24px;display:flex;justify-content:space-between;align-items:center;background:#111c2d;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
    .brand img{width:55px;height:55px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);transition:transform 0.3s ease;}
    .brand img:hover{transform:scale(1.05);}
    .brand h1{font-family: 'Poppins', sans-serif;font-weight: 600;font-size:18px;margin:0;cursor:pointer;display:flex;gap:2px;overflow:hidden;direction:ltr;}
    .brand h1 span{display:inline-block;transition:transform 0.6s ease, opacity 0.6s ease, letter-spacing 0.3s ease, color 0.3s ease;}
    .brand h1.spacing span{transform: translateX(5px);letter-spacing:6px;}
    .brand h1.animate span{opacity:0;transform: translateY(-50px) rotate(20deg);}
    @keyframes bounceback {
      0%{ transform: translateY(0); color:var(--text); }
      25%{ transform: translateY(-14px); color:var(--accent);}
      50%{ transform: translateY(7px); color:var(--accent);}
      75%{ transform: translateY(-4px); color:var(--accent);}
      100%{ transform: translateY(0); color:var(--text);}
    }
    .brand h1 span.bounce{animation:bounceback 0.8s ease;}
    .brand p{margin:0;font-size:13px;color:var(--muted);display:inline}
    nav{display:flex;gap:16px;align-items:center}
    nav a{color:var(--text);text-decoration:none;font-size:14px;cursor:pointer}
    nav a:hover{color:var(--accent)}
    .menu-toggle{display:none;font-size:22px;color:var(--text);cursor:pointer}
    .admin-btn{padding:6px 14px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
    .admin-btn:hover{background:#ff4b8e}

    /* القائمة الجانبية المحدثة */
    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: #111c2d;
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 80px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .side-menu.open {
      transform: translateX(0);
    }

    .side-menu a {
      color: var(--text);
      text-decoration: none;
      font-size: 18px;
      padding: 12px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(255, 107, 157, 0.1); /* لون متناسق مع الألوان الجديدة */
      text-align: center;
    }

    .side-menu a:hover {
      background: var(--accent);
      transform: translateX(-5px);
    }

    .menu-close {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: var(--text);
      background: none;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .menu-close:hover {
      transform: rotate(90deg);
      color: var(--accent);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s ease;
    }

    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    @media (max-width: 768px){
      nav{display:none}
      .menu-toggle{display:block}
    }

    section{padding:40px;text-align:center; display: none;}
    section.active{display: block;}
    section h2{margin-bottom:15px;color:var(--accent)}
    section p{color:var(--muted)}
    .social-icons{display:flex;justify-content:center;gap:15px;margin-top:15px}
    .social-icons a{color:var(--text);font-size:20px;transition:0.3s}
    .social-icons a:hover{color:var(--accent)}
    /* معرض الصور */
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;padding:20px}
    .card{background:var(--card);border-radius:14px;overflow:hidden;position:relative;padding-bottom:10px; transition: transform 0.3s ease, box-shadow 0.3s ease;}
    .card:hover{transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2);}
    .card.dragging{opacity:0.5;border:2px dashed var(--accent)}
    .thumb{width:100%;height:0;padding-bottom:70%;position:relative;overflow:hidden}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;cursor:pointer}
    .meta{padding:12px}
    .meta h3, .meta p{margin:0;color:var(--text)}
    .meta h3[contenteditable], .meta p[contenteditable]{outline:none;cursor:text}
    .meta h3[contenteditable]:focus, .meta p[contenteditable]:focus{border-bottom:1px dashed var(--accent)}
    /* زر الحذف */
    .delete-btn{
      position:absolute;bottom:8px;right:8px;
      background:#e60023;border:none;border-radius:50%;
      color:#fff;width:30px;height:30px;cursor:pointer;
      display:none; /* إخفاء افتراضياً */
      align-items:center;justify-content:center;
    }
    .delete-btn:hover{background:#ff3b3b}

    /* مؤشر التحميل */
    #loader{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center}
    .spinner{border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* زر الإلغاء */
    .cancel-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #ff3b3b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .cancel-btn:hover {
      background: #e60023;
    }

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:100}
    .lightbox.open{display:flex}

    #lbImage {
        max-width: 2048px; /* الحد الأقصى للعرض */
        max-height: 2048px; /* الحد الأقصى للارتفاع */
        width: 90vw; /* لتكون متجاوبة على الشاشات الأصغر */
        height: auto;
        object-fit: contain; /* للحفاظ على نسبة العرض إلى الارتفاع */
    }

    .lightbox.avatar-open #lbImage {
      width: 220px; /* 3x الحجم الأصلي (55px * 3) */
      height: 220px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
      cursor: pointer;
    }

    /* new css for navigation arrows */
    .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
        z-index: 101;
        opacity: 0.8;
        transition: opacity 0.3s;
        user-select: none;
    }

    .nav-arrow:hover {
        opacity: 1;
    }
    .prev-arrow {
        right: 20px; /* تم عكس الموقع */
    }

    .next-arrow {
        left: 20px; /* تم عكس الموقع */
    }

    /* hide arrows when the lightbox is showing the avatar */
    .lightbox.avatar-open .nav-arrow {
        display: none;
    }

    footer{margin-top:auto;padding:20px;text-align:center;font-size:13px;color:var(--muted);background:#111c2d}
    /* cursor for typewriter */
    .cursor {
      display:inline-block;margin-left:2px;
      color:var(--accent);font-weight:bold;
      animation:blink 0.7s steps(1) infinite;
    }
    @keyframes blink {50%{opacity:0;}}

    /* comment section styles */
    .comments-section {
        padding: 10px 12px 10px;
        border-top: 1px solid #252525;
    }
    .comments-list {
        margin-bottom: 10px;
        max-height: 150px;
        overflow-y: auto;
    }
    .comment {
        background: #202020;
        padding: 8px 10px;
        border-radius: 8px;
        margin-bottom: 6px;
        color: var(--muted);
        font-size: 13px;
        display: flex; /* إضافة flexbox لترتيب العناصر */
        justify-content: space-between; /* لتحريك أيقونة الحذف إلى اليمين */
        align-items: center; /* لمحاذاة العناصر عموديًا */
    }
    .comment-delete-btn {
        background: none;
        border: none;
        color: #ff5c5c;
        font-size: 16px;
        cursor: pointer;
        margin-left: 8px; /* مسافة بين التعليق والزر */
        display: none; /* إخفاء افتراضياً */
    }
    .comment-delete-btn:hover {
        color: #e60023;
    }
    .comment-form {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
    }
    .comment-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #333;
        border-radius: 6px;
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        min-width: 0;
    }
    .comment-input:focus {
        outline: none;
        border-color: var(--accent);
    }
    .comment-btn {
        padding: 8px 12px;
        background: #4a90e2; /* لون جديد */
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        display: flex; /* لمركزة الأيقونة */
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* إضافة تظليل */
    }
    .comment-btn:hover {
        background: #3a7acb;
        transform: translateY(-2px); /* تأثير تحريك خفيف */
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    /* animation keyframes */
    @keyframes jump {
      0% { transform: translateY(0); }
      25% { transform: translateY(-5px) rotate(-5deg); }
      50% { transform: translateY(0) rotate(5deg); }
      75% { transform: translateY(-2px) rotate(-2deg); }
      100% { transform: translateY(0); }
    }

    /* animation class */
    .jump-animation {
        animation: jump 0.6s ease-in-out;
    }

    /* add image button style */
    .add-image-btn {
        padding: 10px 20px;
        background-color: var(--accent);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-bottom: 20px;
        box-shadow: 4px 6px rgba(0,0,0,0.1);
    }

    .add-image-btn:hover {
        background-color: #ff4b8e;
    }
    
</style>
</head>
<body>
<header>
<div class="brand">
  <img alt="avatar" id="avatarImg" src="avatar.jpg"/>
  <div>
    <h1 id="name">mohamed tammam</h1>
    <p id="role"></p><span class="cursor">|</span>
  </div>
</div>
<i class="fas fa-bars menu-toggle" id="menuToggle"></i>
<nav>
  <a href="#portfolio" class="nav-link">portfolio</a>
  <a href="#about" class="nav-link">about me</a>
  <a href="#contact" class="nav-link">links</a>
  <button id="auth-btn" class="admin-btn">تسجيل الدخول</button>
</nav>
</header>

<div class="side-menu" id="sideMenu">
  <button class="menu-close" id="menuClose">
    <i class="fas fa-times"></i>
  </button>
  <a href="#portfolio" class="nav-link" onclick="closeMenu()" style="direction: ltr;">portfolio</a>
  <a href="#about" class="nav-link" onclick="closeMenu()">about me</a>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<section id="portfolio" class="active">
  <h2>portfolio</h2>
  <button class="add-image-btn" id="addImageBtn">إضافة صورة جديدة</button>
  <div class="gallery" id="gallery"></div>
  <div class="social-icons">
    <a href="https://pin.it/eox62fequ" target="_blank"><i class="fab fa-pinterest"></i></a>
    <a href="https://www.facebook.com/mo.tammam?mibextid=zbwkwl" target="_blank"><i class="fab fa-facebook"></i></a>
    <a href="https://www.instagram.com/t2mm2m" target="_blank"><i class="fab fa-instagram"></i></a>
  </div>
</section>
<section id="about">
  <h2>about me</h2>
  <p>hi, i'm mohamed tammam.<br/>
    as a concept artist, i strive to give shape to invisible emotions—turning the abstract into visual, tangible worlds.</p>
  <p style="margin-top:15px;">specializing in characters, moods, and narrative-driven visuals.</p>
</section>
<section id="contact">
  <h2>links</h2>

</section>

<div id="loader" style="display: none;">
  <div class="spinner"></div>
  <button class="cancel-btn" id="cancelUpload">إلغاء التحميل</button>
</div>

<div class="lightbox" id="lightbox">
    <button class="nav-arrow prev-arrow" id="prevArrow">‹</button>
    <img id="lbImage" src=""/>
    <button class="nav-arrow next-arrow" id="nextArrow">›</button>
</div>

<footer>© 2025 mohamed tammam. جميع الحقوق محفوظة.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // firebase sdk
  const app = firebase.initializeApp({
    apiKey: "AIzaSyB5WZP74RfeYoPv_kHXRhNtDYzRp2dOPeU",
    authDomain: "mo777-2b57e.firebaseapp.com",
    projectId: "mo777-2b57e",
    storageBucket: "mo777-2b57e.firebasestorage.app",
    messagingSenderId: "318111712614",
    appId: "1:318111712614:web:460e225f4f429c7f13f4a7",
    measurementId: "g-30h1eg57sm"
  });

  const db = firebase.firestore();
  const auth = firebase.auth();

// === بداية قسم javascript ===

// إنشاء معرف فريد للزائر
let visitorId = localStorage.getItem('visitorId');
if (!visitorId) {
    visitorId = crypto.randomUUID();
    localStorage.setItem('visitorId', visitorId);
}

// قائمة الموبايل
const menuToggle = document.getElementById('menuToggle');
const sideMenu = document.getElementById('sideMenu');
const menuOverlay = document.getElementById('menuOverlay');
const menuClose = document.getElementById('menuClose');

function openMenu() {
  sideMenu.classList.add('open');
  menuOverlay.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMenu() {
  sideMenu.classList.remove('open');
  menuOverlay.classList.remove('open');
  document.body.style.overflow = 'auto';
}

menuToggle.onclick = openMenu;
menuClose.onclick = closeMenu;
menuOverlay.onclick = closeMenu;

// إضافة خاصية السحب لفتح وإغلاق القائمة الجانبية
let startX = 0;
document.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
});
document.addEventListener('touchend', (e) => {
    const endX = e.changedTouches[0].clientX;
    const distance = endX - startX;

    // لفتح القائمة: إذا كان السحب من اليسار لليمين بمسافة كافية
    if (distance > 50) {
        openMenu();
    }
    // لإغلاق القائمة: إذا كان السحب من اليمين لليسار بمسافة كافية
    else if (distance < -50 && sideMenu.classList.contains('open')) {
        closeMenu();
    }
});


// إظهار وإخفاء الأقسام مع دعم الهاش في الـ url
const sections = document.querySelectorAll('section');
const navLinks = document.querySelectorAll('.nav-link');

function showSection(sectionId) {
  sections.forEach(section => {
    section.classList.remove('active');
  });
  const el = document.getElementById(sectionId);
  if (el) el.classList.add('active');
}

// عرض القسم الافتراضي عند التحميل (أو من الهاش)
const initialHash = window.location.hash.substring(1) || 'portfolio';
showSection(initialHash);


navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const sectionId = link.getAttribute('href').substring(1);
    // تحديث الهَش في الـ url ليصبح قابل للمشاركة
    history.replaceState(null, '', '#' + sectionId);
    showSection(sectionId);
    // اغلاق القائمة الجانبية لو مفتوحة
    closeMenu();
  });
});

// انيميشن الاسم
const nameEl = document.getElementById('name');
const letters = nameEl.textContent.split('');
nameEl.innerHTML = letters.map((ch, i) => `<span style="transition-delay:${i * 0.05}s">${ch}</span>`).join('');
const spans = nameEl.querySelectorAll('span');
nameEl.onclick = () => {
  nameEl.classList.add('spacing');
  setTimeout(() => {
    nameEl.classList.remove('spacing');
    nameEl.classList.add('animate');
    setTimeout(() => {
      nameEl.classList.remove('animate');
      spans.forEach((span, i) => {
        setTimeout(() => {
          span.classList.add('bounce');
          setTimeout(() => span.classList.remove('bounce'), 800);
        }, i * 70);
      });
    }, 800);
  }, 300);
};

// انيميشن الوظيفة مع عدة ألقاب
const roleEl = document.getElementById("role");
const roles = ["concept artist", "digital artist", "illustrator"];
let roleIndex = 0, charIndex = 0, deleting = false;

function typeWriter() {
  const currentRole = roles[roleIndex];
  if (!deleting && charIndex < currentRole.length) {
    roleEl.textContent += currentRole.charAt(charIndex);
    charIndex++;
    setTimeout(typeWriter, 150);
  } else if (deleting && charIndex > 0) {
    roleEl.textContent = currentRole.substring(0, charIndex - 1);
    charIndex--;
    setTimeout(typeWriter, 100);
  } else {
    if (!deleting) {
      deleting = true;
      setTimeout(typeWriter, 1000);
    } else {
      deleting = false;
      roleIndex = (roleIndex + 1) % roles.length;
      setTimeout(typeWriter, 300);
    }
  }
}
typeWriter();

// معرض الصور
const gallery = document.getElementById('gallery');
let currentImageIndex = -1; // لتتبع الصورة المعروضة في اللايت بوكس

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// تعديل دالة loadImages لاستخدام firebase
async function loadImages() {
  const stored = [];
  try {
    const querySnapshot = await db.collection("portfolioimages").get();
    querySnapshot.forEach((doc) => {
      stored.push({ id: doc.id, ...doc.data() });
    });
  } catch (e) {
    console.error("Error fetching documents: ", e);
    alert('حدث خطأ أثناء تحميل الصور: ' + e.message);
  }

  gallery.innerHTML = '';
  stored.forEach((imgObj, index) => addImageCard(imgObj, index));

  // إعادة ربط أحداث النقر للصور بعد إعادة تحميل المعرض
  gallery.querySelectorAll('.thumb img').forEach((img, index) => {
    img.addEventListener('click', () => {
      currentImageIndex = index;
      document.getElementById('lbImage').src = img.src;
      document.getElementById('lightbox').classList.add('open');
      document.getElementById('lightbox').classList.remove('avatar-open');
    });
  });
  // تحديث حالة أزرار الحذف بناءً على حالة تسجيل الدخول
  updateDeleteButtonVisibility();
}

// تعديل دالة addImageCard لاستخدام firebase
function addImageCard(imgObj, index) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.index = index;

  // التحقق مما إذا كان الزائر قد أعجب بالفعل بهذه الصورة
  const liked = imgObj.likedBy && imgObj.likedBy.includes(visitorId);

  let commentsHtml = `
    <div class="comments-section">
      <div class="comments-list">
        ${(imgObj.comments || []).map((comment, i) => `
          <div class="comment" data-comment-index="${i}">
            <span>${escapeHtml(comment)}</span>
            <button class="comment-delete-btn" data-index="${i}"><i class="fas fa-trash-alt"></i></button>
          </div>
        `).join('')}
      </div>
      <form class="comment-form">
          <input class="comment-input" type="text" placeholder="أضف تعليقًا..." required>
          <button class="comment-btn" type="submit"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>
  `;

  card.innerHTML = `
    <div class="thumb"><img src="${imgObj.src}" alt=""></div>
    <div style="display: flex; align-items: center; justify-content: flex-end; padding: 0 12px 8px;">
        <span class="like-count" style="color: var(--muted); font-size: 14px; margin-right: 8px;">${imgObj.likes || 0}</span>
        <button class="like-btn" style="background: none; border: none; color: ${liked ? 'var(--accent)' : 'var(--muted)'}; cursor: pointer; font-size: 20px;">
            <i class="${liked ? 'fas' : 'far'} fa-heart"></i>
        </button>
        <a href="${imgObj.src}" download="${escapeHtml(imgObj.src).split('/').pop().split('.')[0]}.jpg" class="download-btn" style="color: var(--muted); font-size: 20px; text-decoration: none; margin-left: 8px;">
            <i class="fas fa-download"></i>
        </a>
    </div>
    ${commentsHtml}
    <button class="delete-btn" data-doc-id="${imgObj.id}" data-public-id="${imgObj.publicId}">
        <i class="fas fa-trash-alt"></i>
    </button>
  `;
  gallery.appendChild(card);
  
  const likeBtn = card.querySelector('.like-btn');
  const likeCount = card.querySelector('.like-count');
  const commentForm = card.querySelector('.comment-form');
  const commentInput = card.querySelector('.comment-input');
  const commentsList = card.querySelector('.comments-list');
  const commentBtn = card.querySelector('.comment-btn');
  const deleteBtn = card.querySelector('.delete-btn');

  likeBtn.addEventListener('click', async () => {
    const docRef = db.collection("portfolioimages").doc(imgObj.id);
    const hasLiked = imgObj.likedBy && imgObj.likedBy.includes(visitorId);

    try {
        if (hasLiked) {
            // إلغاء الإعجاب
            await docRef.update({
                likes: firebase.firestore.FieldValue.increment(-1),
                likedBy: firebase.firestore.FieldValue.arrayRemove(visitorId)
            });
            // تحديث الواجهة
            likeCount.textContent = (imgObj.likes || 0) - 1;
            likeBtn.innerHTML = `<i class="far fa-heart"></i>`;
            likeBtn.style.color = 'var(--muted)';
            imgObj.likes -= 1;
            imgObj.likedBy = imgObj.likedBy.filter(id => id !== visitorId);
        } else {
            // إضافة إعجاب
            await docRef.update({
                likes: firebase.firestore.FieldValue.increment(1),
                likedBy: firebase.firestore.FieldValue.arrayUnion(visitorId)
            });
            // تحديث الواجهة
            likeCount.textContent = (imgObj.likes || 0) + 1;
            likeBtn.innerHTML = `<i class="fas fa-heart"></i>`;
            likeBtn.style.color = 'var(--accent)';
            imgObj.likes = (imgObj.likes || 0) + 1;
            imgObj.likedBy = [...(imgObj.likedBy || []), visitorId];
        }
    } catch (e) {
        console.error("Error updating likes: ", e);
        alert('حدث خطأ أثناء تحديث الإعجاب: ' + e.message);
    }
  });


  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const commentText = commentInput.value.trim();
      if (commentText) {
        const docRef = db.collection("portfolioimages").doc(imgObj.id);
        const newComments = [...(imgObj.comments || []), commentText];

        try {
            await docRef.update({ comments: newComments });
            imgObj.comments = newComments;
            const newCommentDiv = document.createElement('div');
            newCommentDiv.className = 'comment';
            newCommentDiv.innerHTML = `<span>${escapeHtml(commentText)}</span>
            <button class="comment-delete-btn" data-index="${newComments.length - 1}"><i class="fas fa-trash-alt"></i></button>`;
            commentsList.appendChild(newCommentDiv);
            commentInput.value = '';
            commentBtn.classList.add('jump-animation');
            setTimeout(() => {
                commentBtn.classList.remove('jump-animation');
            }, 600);
            updateDeleteButtonVisibility(); // تحديث رؤية زر الحذف للتعليق الجديد
        } catch (e) {
            console.error("Error adding comment: ", e);
            alert('حدث خطأ أثناء إضافة التعليق: ' + e.message);
        }
      }
    });
  }

  // إضافة مستمع لحذف التعليقات
  if (commentsList) {
    commentsList.addEventListener('click', async (e) => {
        if (e.target.closest('.comment-delete-btn')) {
            const btn = e.target.closest('.comment-delete-btn');
            const commentIndex = parseInt(btn.dataset.index);

            // تأكد من أن المستخدم مسجل الدخول قبل السماح بالحذف
            if (auth.currentUser) {
                const docRef = db.collection("portfolioimages").doc(imgObj.id);
                const newComments = imgObj.comments.filter((_, i) => i !== commentIndex);
                try {
                    await docRef.update({ comments: newComments });
                    imgObj.comments = newComments;
                    btn.closest('.comment').remove();
                } catch (e) {
                    console.error("Error deleting comment: ", e);
                    alert('حدث خطأ أثناء حذف التعليق: ' + e.message);
                }
            } else {
                alert('يرجى تسجيل الدخول لحذف التعليقات.');
            }
        }
    });
  }
  
  // إضافة مستمع لزر الحذف
  if (deleteBtn) {
    deleteBtn.addEventListener('click', async () => {
        const docId = deleteBtn.dataset.docid;
        const publicId = deleteBtn.dataset.publicid;
        if (confirm("هل أنت متأكد من أنك تريد حذف هذه الصورة؟")) {
            await deleteImage(docId, publicId);
        }
    });
  }
}

// دالة حذف الصورة من cloudinary و firestore
async function deleteImage(docId, publicId) {
    const loader = document.getElementById('loader');
    loader.style.display = 'flex';
    try {
        // الخطوة 1: استدعاء وظيفة الخادم لحذف الصورة من cloudinary
        // تم تحديث الرابط هنا
        const response = await fetch('https://mohamed-git-main-p7ilosop7y-langs-projects.vercel.app/api/delete-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ publicId: publicId })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error('Failed to delete image from Cloudinary: ' + errorData.message);
        }

        // الخطوة 2: حذف المستند من firestore
        await db.collection("portfolioimages").doc(docId).delete();
        
        alert('تم حذف الصورة بنجاح!');
        loadImages(); // إعادة تحميل الصور بعد الحذف
    } catch (error) {
        console.error("Error removing image: ", error);
        alert('حدث خطأ أثناء حذف الصورة: ' + error.message);
    } finally {
        loader.style.display = 'none';
    }
}

// إضافة زر تحميل صورة
const addImageBtn = document.getElementById('addImageBtn');
addImageBtn.addEventListener('click', () => {
    if (auth.currentUser) {
        // تهيئة نافذة رفع cloudinary
        var myWidget = cloudinary.createUploadWidget({
            cloudName: 'dswtpqdsh', // تم تحديث CloudName
            uploadPreset: 'Mohamed' // تم تحديث UploadPreset
        }, async (error, result) => {
            if (!error && result && result.event === "success") {
                const info = result.info;
                console.log('تم! هنا معلومات الصورة: ', info);
                
                try {
                    // إضافة رابط الصورة وبياناتها إلى firestore
                    await db.collection("portfolioimages").add({
                        src: info.secure_url,
                        publicId: info.public_id,
                        likes: 0,
                        likedBy: [],
                        comments: [],
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() // إضافة ختم زمني
                    });
                    
                    // إعادة تحميل الصور بعد إضافة الصورة الجديدة
                    loadImages();
                    alert('تمت إضافة الصورة بنجاح!');
                } catch (e) {
                    console.error("Error adding image: ", e);
                    alert('حدث خطأ أثناء إضافة الصورة: ' + e.message);
                }
            } else if (error) {
                console.error("Cloudinary upload error: ", error);
                alert('حدث خطأ أثناء رفع الصورة إلى Cloudinary: ' + error.message);
            }
        });

        // فتح نافذة الرفع
        myWidget.open();
    } else {
        alert('يرجى تسجيل الدخول للقيام بذلك.');
    }
});


// إغلاق اللايت بوكس بالنقر خارج الصورة
document.getElementById('lightbox').addEventListener('click', (e) => {
  if (e.target.id === 'lightbox') {
    document.getElementById('lightbox').classList.remove('open');
  }
});

// تحميل الصور عند بدء التشغيل
loadImages();

// تكبير الصورة الشخصية
const avatarImg = document.getElementById('avatarImg');
const lightbox = document.getElementById('lightbox');
const lbImage = document.getElementById('lbImage');

avatarImg.addEventListener('click', function() {
    lbImage.src = this.src;
    lightbox.classList.add('open', 'avatar-open');
});

lightbox.addEventListener('click', function(e) {
    // إغلاق اللايت بوكس إذا تم النقر على الخلفية أو الصورة نفسها (وليس الأسهم)
    if (e.target === lightbox || e.target === lbImage) {
        lightbox.classList.remove('open', 'avatar-open');
    }
});

// new code for navigation arrows
const prevArrow = document.getElementById('prevArrow');
const nextArrow = document.getElementById('nextArrow');

prevArrow.addEventListener('click', (e) => {
    e.stopPropagation(); // منع إغلاق اللايت بوكس عند النقر على السهم
    const galleryImages = document.querySelectorAll('#gallery img');
    if (galleryImages.length > 0) {
        currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length; // تم تصحيح الوظيفة
        lbImage.src = galleryImages[currentImageIndex].src;
    }
});

nextArrow.addEventListener('click', (e) => {
    e.stopPropagation(); // منع إغلاق اللايت بوكس عند النقر على السهم
    const galleryImages = document.querySelectorAll('#gallery img');
    if (galleryImages.length > 0) {
        currentImageIndex = (currentImageIndex + 1) % galleryImages.length; // تم تصحيح الوظيفة
        lbImage.src = galleryImages[currentImageIndex].src;
    }
});

// دالة لتحديث رؤية أزرار الحذف بناءً على حالة تسجيل الدخول
function updateDeleteButtonVisibility() {
    const deleteButtons = document.querySelectorAll('.delete-btn');
    const commentDeleteButtons = document.querySelectorAll('.comment-delete-btn');
    if (auth.currentUser) {
        deleteButtons.forEach(btn => btn.style.display = 'flex');
        commentDeleteButtons.forEach(btn => btn.style.display = 'inline-block');
    } else {
        deleteButtons.forEach(btn => btn.style.display = 'none');
        commentDeleteButtons.forEach(btn => btn.style.display = 'none');
    }
}

// إدارة حالة تسجيل الدخول/الخروج وزر الحذف
const authBtn = document.getElementById('auth-btn');
const addImageBtnContainer = document.getElementById('addImageBtn');

auth.onAuthStateChanged((user) => {
  const allowedEmail = 'p7ilosop7y@gmail.com';
  // التحقق مما إذا كان المستخدم مسجلاً دخوله وأن بريده الإلكتروني هو البريد المسموح به فقط
  if (user && user.email === allowedEmail) {
    authBtn.textContent = 'تسجيل الخروج';
    addImageBtnContainer.style.display = 'block';
    // إظهار أزرار الحذف
    updateDeleteButtonVisibility();
  } else {
    // إذا لم يكن المستخدم هو المسموح به، أو لم يكن هناك مستخدم مسجل دخوله
    if (user) {
      // إذا حاول مستخدم آخر تسجيل الدخول، قم بتسجيل خروجه فورًا
      auth.signOut();
      alert('ليس لديك صلاحية الوصول إلى هذه الميزات.');
    }
    authBtn.textContent = 'تسجيل الدخول';
    addImageBtnContainer.style.display = 'none';
    // إخفاء أزرار الحذف
    updateDeleteButtonVisibility();
  }
});

authBtn.addEventListener('click', () => {
    if (authBtn.textContent === 'تسجيل الخروج') {
        auth.signOut().catch(error => {
            console.error("Error signing out: ", error);
            alert('حدث خطأ أثناء تسجيل الخروج: ' + error.message);
        });
    } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            console.error("Error signing in with Google: ", error);
            alert('حدث خطأ أثناء تسجيل الدخول باستخدام جوجل: ' + error.message);
        });
    }
});
</script>
</body>
</html>
