<!doctype html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Mohamed Tammam portfolio</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<style>
    :root{
      /* Original color palette: dark blue and bright pink */
      --bg:#0a0f1a;
      --card:#131c2b;
      --muted: #b0bac8;
      --accent:#ff6b9d; /* Bright pink color */
      --text: #f3f5f7;
    }
    body{font-family:'Poppins', sans-serif;background:var(--bg);color:var(--text);margin:0;display:flex;flex-direction:column;min-height:100vh}
    header{padding:16px 24px;display:flex;justify-content:space-between;align-items:center;background:#111c2d;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
    .brand img{width:55px;height:55px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);transition:transform 0.3s ease;}
    .brand img:hover{transform:scale(1.05);}
    .brand h1{font-family: 'Poppins', sans-serif;font-weight: 600;font-size:18px;margin:0;cursor:pointer;display:flex;gap:2px;overflow:hidden;direction:ltr;}
    .brand h1 span{display:inline-block;transition:transform 0.6s ease, opacity 0.6s ease, letter-spacing 0.3s ease, color 0.3s ease;}
    .brand h1.spacing span{transform: translateX(5px);letter-spacing:6px;}
    .brand h1.animate span{opacity:0;transform: translateY(-50px) rotate(20deg);}
    @keyframes bounceback {
      0%{ transform: translateY(0); color:var(--text); }
      25%{ transform: translateY(-14px); color:var(--accent);}
      50%{ transform: translateY(7px); color:var(--accent);}
      75%{ transform: translateY(-4px); color:var(--accent);}
      100%{ transform: translateY(0); color:var(--text);}
    }
    .brand h1 span.bounce{animation:bounceback 0.8s ease;}
    .brand p{margin:0;font-size:13px;color:var(--muted);display:inline}
    nav{display:flex;gap:16px;align-items:center}
    nav a{color:var(--text);text-decoration:none;font-size:14px;cursor:pointer; transition: letter-spacing 0.3s ease; }
    nav a.spacing-anim{letter-spacing: 5px;}
    nav a:hover{color:var(--accent)}
    .menu-toggle{display:none;font-size:22px;color:var(--text);cursor:pointer}
    .admin-btn{padding:6px 14px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px;}
    .admin-btn:hover{background:#ff4b8e}

    /* Updated side menu */
    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: rgba(17, 28, 45, 0.6); /* Adjusted transparency to 60% */
      backdrop-filter: blur(10px);
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 80px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }

    .side-menu.open {
      transform: translateX(0);
    }

    .side-menu a, .side-menu button {
      color: var(--text);
      text-decoration: none;
      font-size: 18px;
      padding: 12px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(19, 28, 43, 0.8); /* Adjusted transparency to 80% */
      text-align: center;
      border: none;
      cursor: pointer;
    }

    .side-menu a:hover, .side-menu button:hover {
      background: var(--accent);
      transform: translateX(-5px);
    }

    .menu-close {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 24px;
      color: var(--text);
      background: none;
      border: none;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .menu-close:hover {
      transform: rotate(90deg);
      color: var(--accent);
    }

    .menu-overlay {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s ease;
    }

    .menu-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    @media (max-width: 768px){
      nav{display:none}
      .menu-toggle{display:block}
    }

    section{padding:40px;text-align:center; display: none;}
    section.active{display: block;}
    section h2{margin-bottom:15px;color:var(--accent)}
    section p{color:var(--muted)}
    .social-icons{display:flex;justify-content:center;gap:15px;margin-top:15px}
    .social-icons a{color:var(--text);font-size:20px;transition:0.3s}
    .social-icons a:hover{color:var(--accent)}
    /* Image gallery */
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;padding:20px}
    .card{background: rgba(19, 28, 43, 0.6); border-radius:14px;overflow:hidden;position:relative;padding-bottom:10px; transition: transform 0.3s ease, box-shadow 0.3s ease;}
    .card:hover{transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.2);}
    .card.dragging{opacity:0.5;border:2px dashed var(--accent)}
    .thumb{width:100%;height:0;padding-bottom:70%;position:relative;overflow:hidden}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;cursor:pointer}
    .meta{padding:12px}
    .meta h3, .meta p{margin:0;color:var(--text)}
    .meta h3[contenteditable], .meta p[contenteditable]{outline:none;cursor:text}
    .meta h3[contenteditable]:focus, .meta p[contenteditable]:focus{border-bottom:1px dashed var(--accent)}

    /* Loader */
    #loader{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center}
    .spinner{border:6px solid #f3f3f3;border-top:6px solid var(--accent);border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Cancel button */
    .cancel-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #ff3b3b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .cancel-btn:hover {
      background: #e60023;
    }

    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:100}
    .lightbox.open{display:flex}

    /* خصائص الصورة في حالتها الطبيعية وفي وضع الانتقال */
    #lbImage {
        max-width: 2048px;
        max-height: 2048px;
        width: 90vw;
        height: auto;
        object-fit: contain;
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    /* خصائص الصورة الشخصية عند فتح النافذة المنبثقة */
    .lightbox.avatar-open #lbImage {
      width: 220px; /* 3x original size (55px * 3) */
      height: 220px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 107, 157, 0.5);
      cursor: pointer;
      
      /* خصائص الحركة النهائية */
      transform: scale(1);
      opacity: 1;
    }
    
    /* خصائص الصورة عندما تكون في وضع البداية (قبل فتح النافذة المنبثقة) */
    .lightbox #lbImage {
      transform: scale(0.5);
      opacity: 0;
    }


    /* New CSS for navigation arrows */
    .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
        z-index: 101;
        opacity: 0.8;
        transition: opacity 0.3s;
        user-select: none;
    }

    .nav-arrow:hover {
        opacity: 1;
    }
    .prev-arrow {
        right: 20px; /* Swapped to the right */
    }

    .next-arrow {
        left: 20px; /* Swapped to the left */
    }

    /* Hide arrows when the lightbox is showing the avatar */
    .lightbox.avatar-open .nav-arrow {
        display: none;
    }

    footer{margin-top:auto;padding:20px;text-align:center;font-size:13px;color:var(--muted);background:#111c2d}
    /* cursor for typewriter */
    .cursor {
      display:inline-block;margin-left:2px;
      color:var(--accent);font-weight:bold;
      animation:blink 0.7s steps(1) infinite;
    }
    @keyframes blink {50%{opacity:0;}}

    /* comment section styles */
    .comments-section {
        padding: 10px 12px 10px;
        border-top: 1px solid #252525;
    }
    .comments-list {
        margin-bottom: 10px;
        max-height: 150px;
        overflow-y: auto;
    }
    .comment {
        background: #202020;
        padding: 8px 10px;
        border-radius: 8px;
        margin-bottom: 6px;
        color: var(--muted);
        font-size: 13px;
        display: flex; /* Added flexbox to arrange elements */
        justify-content: space-between; /* To move the delete icon to the right */
        align-items: center; /* To vertically align elements */
    }
    .comment-delete-btn {
        background: none;
        border: none;
        color: #ff5c5c;
        font-size: 16px;
        cursor: pointer;
        margin-left: 8px; /* Space between comment and button */
        display: none; /* Hidden by default */
    }
    .comment-delete-btn:hover {
        color: #e60023;
    }
    .comment-form {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
    }
    .comment-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #333;
        border-radius: 6px;
        background: var(--card);
        color: var(--text);
        font-size: 14px;
        min-width: 0;
    }
    .comment-input:focus {
        outline: none;
        border-color: var(--accent);
    }
    .comment-btn {
        padding: 8px 12px;
        background: var(--accent); /* New color */
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        display: flex; /* To center the icon */
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Add shadow */
    }
    .comment-btn:hover {
        background: #ff4b8e;
        transform: translateY(-2px); /* Slight hover effect */
        box-shadow: 0 6px 8px rgba(0,0,0,0.15);
    }

    /* animation keyframes */
    @keyframes jump {
      0% { transform: translateY(0); }
      25% { transform: translateY(-5px) rotate(-5deg); }
      50% { transform: translateY(0) rotate(5deg); }
      75% { transform: translateY(-2px) rotate(-2deg); }
      100% { transform: translateY(0); }
    }

    /* animation class */
    .jump-animation {
        animation: jump 0.6s ease-in-out;
    }

    /* add image button style */
    .add-image-btn {
        padding: 10px 20px;
        background-color: var(--accent);
        color: #fff;
        border: none;
        border-radius: 8-px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-bottom: 20px;
        box-shadow: 4px 6px rgba(0,0,0,0.1);
        display: none; /* Hidden by default, shown on admin login */
    }

    .add-image-btn:hover {
        background-color: #ff4b8e;
    }

    .card .title-container {
        padding: 12px;
        text-align: right;
    }

    .card .title-container h3 {
        margin: 0;
        color: var(--text);
        font-size: 16px;
        font-weight: 600;
        outline: none;
        cursor: text;
    }

    .card .title-container h3:focus {
        border-bottom: 1px dashed var(--accent);
    }
    
    /* New styles for category buttons */
    .filter-btn {
        padding: 8px 16px;
        margin: 0 5px;
        background: rgba(19, 28, 43, 0.8);
        color: var(--text);
        border: 1px solid var(--card);
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .filter-btn:hover {
        background: var(--card);
        transform: translateY(-2px);
    }
    
    .filter-btn.active {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
        transform: translateY(-2px);
    }
</style>
</head>
<body>
<header>
<div class="brand">
  <img alt="avatar" id="avatarImg" src="avatar.jpg"/>
  <div>
    <h1 id="name">Mohamed Tammam</h1>
    <p id="role"></p><span class="cursor">|</span>
  </div>
</div>
<i class="fas fa-bars menu-toggle" id="menuToggle"></i>
<nav>
  <a href="#portfolio" id="portfolio-link" class="nav-link">portfolio</a>
  <a href="#about" class="nav-link">about me</a>
  </nav>
</header>

<div class="side-menu" id="sideMenu">
  <button class="menu-close" id="menuClose">
    <i class="fas fa-times"></i>
  </button>
  <a href="#portfolio" id="side-portfolio-link" class="nav-link" onclick="closeMenu()" style="direction: ltr;">portfolio</a>
  <a href="#about" class="nav-link" onclick="closeMenu()">about me</a>
  <button id="auth-btn" class="admin-btn">تسجيل الدخول</button>
</div>
<div class="menu-overlay" id="menuOverlay"></div>

<section id="portfolio" class="active">
  <h2>portfolio</h2>
  <button class="add-image-btn" id="addImageBtn">إضافة صورة جديدة</button>
  <div class="category-filter" style="text-align:center; margin-bottom: 20px;">
    <button class="filter-btn active" data-category="all">All</button>
    <button class="filter-btn" data-category="illustration">Illustration</button>
    <button class="filter-btn" data-category="concept">Concept Art</button>
    <button class="filter-btn" data-category="character">Character Design</button>
  </div>
  <div class="gallery" id="gallery"></div>
  <div class="social-icons">
    <a href="https://pin.it/eox62fequ" target="_blank"><i class="fab fa-pinterest"></i></a>
    <a href="https://www.facebook.com/mo.tammam?mibextid=zbwkwl" target="_blank"><i class="fab fa-facebook"></i></a>
    <a href="https://www.instagram.com/t2mm2m" target="_blank"><i class="fab fa-instagram"></i></a>
  </div>
</section>
<section id="about">
  <h2>about me</h2>
  <p>hi, i'm Mohamed Tammam.<br/>
    as a concept artist, i strive to give shape to invisible emotions—turning the abstract into visual, tangible worlds.</p>
  <p style="margin-top:15px;">specializing in characters, moods, and narrative-driven visuals.</p>
</section>

<div id="loader" style="display: none;">
  <div class="spinner"></div>
  <button class="cancel-btn" id="cancelUpload">إلغاء التحميل</button>
</div>

<div class="lightbox" id="lightbox">
    <button class="nav-arrow prev-arrow" id="prevArrow">‹</button>
    <img id="lbImage" src=""/>
    <button class="nav-arrow next-arrow" id="nextArrow">›</button>
</div>

<footer>© 2025 Mohamed Tammam. جميع الحقوق محفوظة.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Firebase SDK configuration
  const app = firebase.initializeApp({
    apiKey: "AIzaSyB5WZP74RfeYoPv_kHXRhNtDYzRp2dOPeU",
    authDomain: "mo777-2b57e.firebaseapp.com",
    projectId: "mo777-2b57e",
    storageBucket: "mo777-2b57e.firebasestorage.app",
    messagingSenderId: "318111712614",
    appId: "1:318111712614:web:460e225f4f429c7f13f4a7",
    measurementId: "g-30h1eg57sm"
  });

  const db = firebase.firestore();
  const auth = firebase.auth();
  let cloudinaryWidget = null; // A variable to hold the Cloudinary widget instance

// === Start of JavaScript section ===

// Create a unique ID for the visitor
let visitorId = localStorage.getItem('visitorId');
if (!visitorId) {
    visitorId = crypto.randomUUID();
    localStorage.setItem('visitorId', visitorId);
}

// Mobile menu
const menuToggle = document.getElementById('menuToggle');
const sideMenu = document.getElementById('sideMenu');
const menuOverlay = document.getElementById('menuOverlay');
const menuClose = document.getElementById('menuClose');

function openMenu() {
  sideMenu.classList.add('open');
  menuOverlay.classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeMenu() {
  sideMenu.classList.remove('open');
  menuOverlay.classList.remove('open');
  document.body.style.overflow = 'auto';
}

menuToggle.onclick = openMenu;
menuClose.onclick = closeMenu;
menuOverlay.onclick = closeMenu;

// Add swipe functionality to open/close the side menu
let startX = 0;
document.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
});
document.addEventListener('touchend', (e) => {
    const endX = e.changedTouches[0].clientX;
    const distance = endX - startX;

    // Open the menu if swiping from left to right with sufficient distance
    if (distance > 50) {
        openMenu();
    }
    // Close the menu if swiping from right to left with sufficient distance
    else if (distance < -50 && sideMenu.classList.contains('open')) {
        closeMenu();
    }
});


// Show/hide sections with URL hash support
const sections = document.querySelectorAll('section');
const navLinks = document.querySelectorAll('.nav-link');

function showSection(sectionId) {
  sections.forEach(section => {
    section.classList.remove('active');
  });
  const el = document.getElementById(sectionId);
  if (el) el.classList.add('active');
}

// Show the default section on load (or from the hash)
const initialHash = window.location.hash.substring(1) || 'portfolio';
showSection(initialHash);


navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const sectionId = link.getAttribute('href').substring(1);
    // Update the hash in the URL to make it shareable
    history.replaceState(null, '', '#' + sectionId);
    showSection(sectionId);
    // Close the side menu if it's open
    closeMenu();
  });
});

// Name animation
const nameEl = document.getElementById('name');
const letters = nameEl.textContent.split('');
nameEl.innerHTML = letters.map((ch, i) => `<span style="transition-delay:${i * 0.05}s">${ch}</span>`).join('');
const spans = nameEl.querySelectorAll('span');
nameEl.onclick = () => {
  nameEl.classList.add('spacing');
  setTimeout(() => {
    nameEl.classList.remove('spacing');
    nameEl.classList.add('animate');
    setTimeout(() => {
      nameEl.classList.remove('animate');
      spans.forEach((span, i) => {
        setTimeout(() => {
          span.classList.add('bounce');
          setTimeout(() => span.classList.remove('bounce'), 800);
        }, i * 70);
      });
    }, 800);
  }, 300);
};

// Role typewriter animation
const roleEl = document.getElementById("role");
const roles = ["concept artist", "digital artist", "illustrator"];
let roleIndex = 0, charIndex = 0, deleting = false;

function typeWriter() {
  const currentRole = roles[roleIndex];
  if (!deleting && charIndex < currentRole.length) {
    roleEl.textContent += currentRole.charAt(charIndex);
    charIndex++;
    setTimeout(typeWriter, 150);
  } else if (deleting && charIndex > 0) {
    roleEl.textContent = currentRole.substring(0, charIndex - 1);
    charIndex--;
    setTimeout(typeWriter, 100);
  } else {
    if (!deleting) {
      deleting = true;
      setTimeout(typeWriter, 1000);
    } else {
      deleting = false;
      roleIndex = (roleIndex + 1) % roles.length;
      setTimeout(typeWriter, 300);
    }
  }
}
typeWriter();

// Image gallery functions
const gallery = document.getElementById('gallery');
let currentImageIndex = -1; // To track the image shown in the lightbox
let allImages = []; // To store all images for lightbox navigation

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Function to delete a comment (only for admin)
async function deleteComment(imgId, commentIndex, cardElement) {
    const docRef = db.collection("portfolioimages").doc(imgId);
    try {
        const doc = await docRef.get();
        if (doc.exists) {
            const data = doc.data();
            const newComments = data.comments;
            newComments.splice(commentIndex, 1);
            await docRef.update({ comments: newComments });
            // Remove the comment from the UI
            cardElement.remove();
        }
    } catch (e) {
        console.error("Error deleting comment: ", e);
        alert('حدث خطأ أثناء حذف التعليق: ' + e.message);
    }
}

// Function to delete an image (This function is now obsolete but kept for reference)
async function deleteImage(imgId, publicId) {
    // The code for deleting an image has been completely removed to prevent accidental deletion.
    // This function will not be called from the UI anymore.
    console.log("Delete functionality is disabled.");
}

// Modified loadImages function to use firebase with category filter
async function loadImages(category = 'all') {
  const stored = [];
  try {
    let query = db.collection("portfolioimages").orderBy("timestamp", "desc");
    
    // If a specific category is selected, add a filter to the query
    if (category !== 'all') {
      query = query.where("category", "==", category);
    }

    const querySnapshot = await query.get();
    querySnapshot.forEach((doc) => {
      stored.push({ id: doc.id, ...doc.data() });
    });
    
    allImages = stored; // Store the images in the global array
  } catch (e) {
    console.error("Error fetching documents: ", e);
    alert('An error occurred while loading images: ' + e.message);
  }

  gallery.innerHTML = '';
  stored.forEach((imgObj, index) => addImageCard(imgObj, index));
}


// Modified addImageCard function to use firebase
function addImageCard(imgObj, index) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.index = index;

  // Check if the visitor has already liked this image
  const liked = imgObj.likedBy && imgObj.likedBy.includes(visitorId);
  const isAdmin = auth.currentUser && auth.currentUser.email === 'p7ilosop7y@gmail.com';

  let commentsHtml = `
    <div class="comments-section">
      <div class="comments-list">
        ${(imgObj.comments || []).map((comment, i) => `
          <div class="comment" data-comment-index="${i}">
            <span>${escapeHtml(comment)}</span>
            ${isAdmin ? `<button class="comment-delete-btn" data-img-id="${imgObj.id}" data-comment-index="${i}" title="حذف التعليق"><i class="fas fa-trash"></i></button>` : ''}
          </div>
        `).join('')}
      </div>
      <form class="comment-form">
          <input class="comment-input" type="text" placeholder="أضف تعليقًا..." required>
          <button class="comment-btn" type="submit"><i class="fas fa-paper-plane"></i></button>
      </form>
    </div>
  `;
  
  const titleHtml = `<div class="title-container">
      <h3 class="editable-title" data-img-id="${imgObj.id}" ${isAdmin ? 'contenteditable="true"' : ''}>
          ${escapeHtml(imgObj.title || 'Untitled Image')}
      </h3>
  </div>`;

  card.innerHTML = `
    <div class="thumb"><img src="${imgObj.src}" alt=""></div>
    ${titleHtml}
    <div style="display: flex; align-items: center; justify-content: flex-end; padding: 0 12px 8px;">
        <span class="like-count" style="color: var(--muted); font-size: 14px; margin-right: 8px;">${imgObj.likes || 0}</span>
        <button class="like-btn" style="background: none; border: none; color: ${liked ? 'var(--accent)' : 'var(--muted)'}; cursor: pointer; font-size: 20px;">
            <i class="${liked ? 'fas' : 'far'} fa-heart"></i>
        </button>
        <button class="download-btn" data-img-url="${imgObj.src}" style="background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; margin-left: 8px;">
            <i class="fas fa-download"></i>
        </button>
    </div>
    ${commentsHtml}
  `;
  gallery.appendChild(card);

  // Add event listeners
  const likeBtn = card.querySelector('.like-btn');
  const likeCount = card.querySelector('.like-count');
  const commentForm = card.querySelector('.comment-form');
  const commentInput = card.querySelector('.comment-input');
  const commentsList = card.querySelector('.comments-list');
  const commentBtn = card.querySelector('.comment-btn');
  const imageThumb = card.querySelector('.thumb img');
  const downloadBtn = card.querySelector('.download-btn');

  // Event listener for download button
  downloadBtn.addEventListener('click', async () => {
      const imageUrl = downloadBtn.dataset.imgUrl;
      const imageName = imageUrl.split('/').pop();
      try {
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const blobUrl = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = imageName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(blobUrl);
      } catch (error) {
          console.error("Error downloading image:", error);
          alert('حدث خطأ أثناء تحميل الصورة.');
      }
  });


  // Event listener for title change (only for admin)
  if (isAdmin) {
      const titleElement = card.querySelector('.editable-title');
      if (titleElement) {
          titleElement.addEventListener('blur', async () => {
              const newTitle = titleElement.textContent.trim();
              if (newTitle !== (imgObj.title || 'Untitled Image')) {
                  const docRef = db.collection("portfolioimages").doc(titleElement.dataset.imgId);
                  try {
                      await docRef.update({ title: newTitle });
                      imgObj.title = newTitle; // Update local object
                  } catch (e) {
                      console.error("Error updating title: ", e);
                      alert('An error occurred while updating the title: ' + e.message);
                  }
              }
          });
      }
  }

  // Event listeners for comment delete buttons
  if (isAdmin) {
    card.querySelectorAll('.comment-delete-btn').forEach(btn => {
      btn.style.display = 'block'; // Show delete button for admin
      btn.addEventListener('click', () => {
        const commentCard = btn.closest('.comment');
        deleteComment(btn.dataset.imgId, btn.dataset.commentIndex, commentCard);
      });
    });
  }

  // Event listener for image thumbnail click to open lightbox
  imageThumb.addEventListener('click', () => {
      currentImageIndex = index;
      document.getElementById('lbImage').src = imageThumb.src;
      document.getElementById('lightbox').classList.add('open');
      document.getElementById('lightbox').classList.remove('avatar-open');
  });

  // Event listener for like button
  likeBtn.addEventListener('click', async () => {
    const docRef = db.collection("portfolioimages").doc(imgObj.id);
    const hasLiked = imgObj.likedBy && imgObj.likedBy.includes(visitorId);

    try {
        if (hasLiked) {
            // Unlike
            await docRef.update({
                likes: firebase.firestore.FieldValue.increment(-1),
                likedBy: firebase.firestore.FieldValue.arrayRemove(visitorId)
            });
            // Update UI
            likeCount.textContent = (imgObj.likes || 0) - 1;
            likeBtn.innerHTML = `<i class="far fa-heart"></i>`;
            likeBtn.style.color = 'var(--muted)';
            imgObj.likes -= 1;
            imgObj.likedBy = imgObj.likedBy.filter(id => id !== visitorId);
        } else {
            // Like
            await docRef.update({
                likes: firebase.firestore.FieldValue.increment(1),
                likedBy: firebase.firestore.FieldValue.arrayUnion(visitorId)
            });
            // Update UI
            likeCount.textContent = (imgObj.likes || 0) + 1;
            likeBtn.innerHTML = `<i class="fas fa-heart"></i>`;
            likeBtn.style.color = 'var(--accent)';
            imgObj.likes = (imgObj.likes || 0) + 1;
            imgObj.likedBy = [...(imgObj.likedBy || []), visitorId];
        }
    } catch (e) {
        console.error("Error updating likes: ", e);
        alert('An error occurred while updating the like: ' + e.message);
    }
  });


  // Event listener for comment form submission
  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const commentText = commentInput.value.trim();
      if (commentText) {
        const docRef = db.collection("portfolioimages").doc(imgObj.id);
        const newComments = [...(imgObj.comments || []), commentText];

        try {
            await docRef.update({ comments: newComments });
            imgObj.comments = newComments;
            const newCommentDiv = document.createElement('div');
            newCommentDiv.className = 'comment';
            newCommentDiv.innerHTML = `<span>${escapeHtml(commentText)}</span>`;
            commentsList.appendChild(newCommentDiv);
            commentInput.value = '';
            commentBtn.classList.add('jump-animation');
            setTimeout(() => {
                commentBtn.classList.remove('jump-animation');
            }, 600);
        } catch (e) {
            console.error("Error adding comment: ", e);
            alert('An error occurred while adding the comment: ' + e.message);
        }
      }
    });
  }
}

// Add image button
const addImageBtn = document.getElementById('addImageBtn');
addImageBtn.addEventListener('click', () => {
    if (auth.currentUser) {
        // Initialize the Cloudinary upload widget
        cloudinaryWidget = cloudinary.createUploadWidget({
            cloudName: 'dswtpqdsh',
            uploadPreset: 'Mohamed'
        }, async (error, result) => {
            if (!error && result && result.event === "success") {
                const info = result.info;
                console.log('Done! Here is the image info: ', info);
                
                try {
                    // Add the image link and data to Firestore
                    await db.collection("portfolioimages").add({
                        src: info.secure_url,
                        publicId: info.public_id, // Store the publicId for deletion
                        likes: 0,
                        likedBy: [],
                        comments: [],
                        title: 'Untitled Image', // Add the default title
                        category: 'illustration', // Add the category
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Reload images after adding the new image
                    loadImages();
                    alert('Image added successfully!');
                } catch (e) {
                    console.error("Error adding image: ", e);
                    alert('An error occurred while adding the image: ' + e.message);
                }
            } else if (error) {
                console.error("Cloudinary upload error: ", error);
                alert('An error occurred while uploading the image to Cloudinary: ' + error.message);
            }
        });

        // Open the upload widget
        cloudinaryWidget.open();
    } else {
        alert('Please log in to do this.');
    }
});

// Cancel upload functionality
document.getElementById('cancelUpload').addEventListener('click', () => {
    if (cloudinaryWidget) {
        // You might need to handle this differently based on the Cloudinary widget version
        // This is a placeholder for a hypothetical cancel function
        alert('Upload cancelled.');
        // Hide loader if it's visible
    }
    document.getElementById('loader').style.display = 'none';
});


// Lightbox functionality
const lightbox = document.getElementById('lightbox');
const lbImage = document.getElementById('lbImage');

// Open avatar in lightbox
const avatarImg = document.getElementById('avatarImg');
avatarImg.addEventListener('click', function() {
    lbImage.src = this.src;
    lightbox.classList.add('open', 'avatar-open');
});

// Close lightbox by clicking on background or image
lightbox.addEventListener('click', (e) => {
  if (e.target === lightbox || e.target === lbImage) {
    lightbox.classList.remove('open', 'avatar-open');
  }
});

// Lightbox navigation arrows
const prevArrow = document.getElementById('prevArrow');
const nextArrow = document.getElementById('nextArrow');

prevArrow.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent closing the lightbox
    if (allImages.length > 0) {
        currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
        lbImage.src = allImages[currentImageIndex].src;
    }
});

nextArrow.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent closing the lightbox
    if (allImages.length > 0) {
        currentImageIndex = (currentImageIndex + 1) % allImages.length;
        lbImage.src = allImages[currentImageIndex].src;
    }
});

// Manage login/logout state and delete button visibility
const authBtn = document.getElementById('auth-btn');
const addImageBtnContainer = document.getElementById('addImageBtn');
const allowedEmail = 'p7ilosop7y@gmail.com';

auth.onAuthStateChanged((user) => {
  // Check if the user is logged in and their email is the allowed one
  if (user && user.email === allowedEmail) {
    authBtn.textContent = 'تسجيل الخروج';
    addImageBtnContainer.style.display = 'block';
    loadImages(); // Reload images to show admin features
  } else {
    // If another user tries to log in, or no user is logged in
    if (user) {
      // If another user attempts to log in, sign them out immediately
      auth.signOut();
      alert('You do not have permission to access these features.');
    }
    authBtn.textContent = 'تسجيل الدخول';
    addImageBtnContainer.style.display = 'none';
    loadImages(); // Reload images to hide admin features
  }
});

authBtn.addEventListener('click', () => {
    if (authBtn.textContent === 'تسجيل الخروج') {
        auth.signOut().catch(error => {
            console.error("Error signing out: ", error);
            alert('An error occurred while signing out: ' + error.message);
        });
    } else {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            console.error("Error signing in with Google: ", error);
            alert('An error occurred while signing in with Google: ' + error.message);
        });
    }
});

// Add animation to the "portfolio" link
document.addEventListener('DOMContentLoaded', () => {
    const portfolioLink = document.getElementById('portfolio-link');
    const sidePortfolioLink = document.getElementById('side-portfolio-link');
    
    // Create a function to handle the animation and page transition
    function handlePortfolioClick(e) {
        e.preventDefault(); 
        
        // Add the animation class
        if (e.target.id === 'portfolio-link') {
            portfolioLink.classList.add('spacing-anim');
        } else if (e.target.id === 'side-portfolio-link') {
            sidePortfolioLink.classList.add('spacing-anim');
        }
        
        // After a short delay to let the animation play, perform the page transition
        setTimeout(() => {
            const sectionId = e.target.getAttribute('href').substring(1);
            history.replaceState(null, '', '#' + sectionId);
            showSection(sectionId);
            closeMenu();
            
            // Remove the animation class after the transition is complete
            if (e.target.id === 'portfolio-link') {
                portfolioLink.classList.remove('spacing-anim');
            } else if (e.target.id === 'side-portfolio-link') {
                sidePortfolioLink.classList.remove('spacing-anim');
            }
        }, 500); // Wait 500ms to allow the animation to play
    }
    
    if (portfolioLink) {
        portfolioLink.addEventListener('click', handlePortfolioClick);
    }
    if (sidePortfolioLink) {
        sidePortfolioLink.addEventListener('click', handlePortfolioClick);
    }
});

// Category filtering functionality
const filterButtons = document.querySelectorAll('.filter-btn');

filterButtons.forEach(button => {
    button.addEventListener('click', () => {
        // Remove 'active' class from all buttons
        filterButtons.forEach(btn => btn.classList.remove('active'));
        // Add 'active' class to the clicked button
        button.classList.add('active');
        
        // Get the category from the button's data attribute
        const category = button.dataset.category;
        // Load images for the selected category
        loadImages(category);
    });
});
</script>
</body>
</html>
